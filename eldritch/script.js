const cardsBlue = [
    {
        id: 'blue1',
        cardFace: './assets/MythicCards/blue/blue1.png',
        difficulty: 'hard',
        color: 'blue'
    },
    {
        id: 'blue2',
        cardFace: './assets/MythicCards/blue/blue2.png',
        difficulty: 'hard',
        color: 'blue'
    },
    {
        id: 'blue3',
        cardFace: './assets/MythicCards/blue/blue3.png',
        difficulty: 'easy',
        color: 'blue'
    },
    {
        id: 'blue4',
        cardFace: './assets/MythicCards/blue/blue4.png',
        difficulty: 'easy',
        color: 'blue'
    },
    {
        id: 'blue5',
        cardFace: './assets/MythicCards/blue/blue5.png',
        difficulty: 'easy',
        color: 'blue'
    },
    {
        id: 'blue6',
        cardFace: './assets/MythicCards/blue/blue6.png',
        difficulty: 'hard',
        color: 'blue'
    },
    {
        id: 'blue7',
        cardFace: './assets/MythicCards/blue/blue7.png',
        difficulty: 'normal',
        color: 'blue'
    },
    {
        id: 'blue8',
        cardFace: './assets/MythicCards/blue/blue8.png',
        difficulty: 'hard',
        color: 'blue'
    },
    {
        id: 'blue9',
        cardFace: './assets/MythicCards/blue/blue9.png',
        difficulty: 'normal',
        color: 'blue'
    },
    {
        id: 'blue10',
        cardFace: './assets/MythicCards/blue/blue10.png',
        difficulty: 'easy',
        color: 'blue'
    },
    {
        id: 'blue11',
        cardFace: './assets/MythicCards/blue/blue11.png',
        difficulty: 'normal',
        color: 'blue'
    },
    {
        id: 'blue12',
        cardFace: './assets/MythicCards/blue/blue12.png',
        difficulty: 'normal',
        color: 'blue'
    },
]
const cardsBrown = [
    {
        id: 'brown1',
        cardFace: './assets/MythicCards/brown/brown1.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown2',
        cardFace: './assets/MythicCards/brown/brown2.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown3',
        cardFace: './assets/MythicCards/brown/brown3.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown4',
        cardFace: './assets/MythicCards/brown/brown4.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown5',
        cardFace: './assets/MythicCards/brown/brown5.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown6',
        cardFace: './assets/MythicCards/brown/brown6.png',
        difficulty: 'hard',
        color: 'brown'
    },
    {
        id: 'brown7',
        cardFace: './assets/MythicCards/brown/brown7.png',
        difficulty: 'hard',
        color: 'brown'
    },
    {
        id: 'brown8',
        cardFace: './assets/MythicCards/brown/brown8.png',
        difficulty: 'hard',
        color: 'brown'
    },
    {
        id: 'brown9',
        cardFace: './assets/MythicCards/brown/brown9.png',
        difficulty: 'hard',
        color: 'brown'
    },
    {
        id: 'brown10',
        cardFace: './assets/MythicCards/brown/brown10.png',
        difficulty: 'hard',
        color: 'brown'
    },
    {
        id: 'brown11',
        cardFace: './assets/MythicCards/brown/brown11.png',
        difficulty: 'easy',
        color: 'brown'
    },
    {
        id: 'brown12',
        cardFace: './assets/MythicCards/brown/brown12.png',
        difficulty: 'easy',
        color: 'brown'
    },
    {
        id: 'brown13',
        cardFace: './assets/MythicCards/brown/brown13.png',
        difficulty: 'easy',
        color: 'brown'
    },
    {
        id: 'brown14',
        cardFace: './assets/MythicCards/brown/brown14.png',
        difficulty: 'easy',
        color: 'brown'
    },
    {
        id: 'brown15',
        cardFace: './assets/MythicCards/brown/brown15.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown16',
        cardFace: './assets/MythicCards/brown/brown16.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown17',
        cardFace: './assets/MythicCards/brown/brown17.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown18',
        cardFace: './assets/MythicCards/brown/brown18.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown19',
        cardFace: './assets/MythicCards/brown/brown19.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown20',
        cardFace: './assets/MythicCards/brown/brown20.png',
        difficulty: 'normal',
        color: 'brown'
    },
    {
        id: 'brown21',
        cardFace: './assets/MythicCards/brown/brown21.png',
        difficulty: 'easy',
        color: 'brown'
    },
]
const cardsGreen = [
    {
        id: 'green1',
        cardFace: './assets/MythicCards/green/green1.png',
        difficulty: 'easy',
        color: 'green'
    },
    {
        id: 'green2',
        cardFace: './assets/MythicCards/green/green2.png',
        difficulty: 'hard',
        color: 'green'
    },
    {
        id: 'green3',
        cardFace: './assets/MythicCards/green/green3.png',
        difficulty: 'hard',
        color: 'green'
    },
    {
        id: 'green4',
        cardFace: './assets/MythicCards/green/green4.png',
        difficulty: 'hard',
        color: 'green'
    },
    {
        id: 'green5',
        cardFace: './assets/MythicCards/green/green5.png',
        difficulty: 'hard',
        color: 'green'
    },
    {
        id: 'green6',
        cardFace: './assets/MythicCards/green/green6.png',
        difficulty: 'hard',
        color: 'green'
    },
    {
        id: 'green7',
        cardFace: './assets/MythicCards/green/green7.png',
        difficulty: 'normal',
        color: 'green'
    },
    {
        id: 'green8',
        cardFace: './assets/MythicCards/green/green8.png',
        difficulty: 'normal',
        color: 'green'
    },
    {
        id: 'green9',
        cardFace: './assets/MythicCards/green/green9.png',
        difficulty: 'normal',
        color: 'green'
    },
    {
        id: 'green10',
        cardFace: './assets/MythicCards/green/green10.png',
        difficulty: 'normal',
        color: 'green'
    },
    {
        id: 'green11',
        cardFace: './assets/MythicCards/green/green11.png',
        difficulty: 'normal',
        color: 'green'
    },
    {
        id: 'green12',
        cardFace: './assets/MythicCards/green/green12.png',
        difficulty: 'easy',
        color: 'green'
    },
    {
        id: 'green13',
        cardFace: './assets/MythicCards/green/green13.png',
        difficulty: 'normal',
        color: 'green'
    },
    {
        id: 'green14',
        cardFace: './assets/MythicCards/green/green14.png',
        difficulty: 'normal',
        color: 'green'
    },
    {
        id: 'green15',
        cardFace: './assets/MythicCards/green/green15.png',
        difficulty: 'normal',
        color: 'green'
    },
    {
        id: 'green16',
        cardFace: './assets/MythicCards/green/green16.png',
        difficulty: 'easy',
        color: 'green'
    },
    {
        id: 'green17',
        cardFace: './assets/MythicCards/green/green17.png',
        difficulty: 'easy',
        color: 'green'
    },
    {
        id: 'green18',
        cardFace: './assets/MythicCards/green/green18.png',
        difficulty: 'easy',
        color: 'green'
    },
]
const ancients = [
    {
        id: 'azathoth',
        name: 'azathoth',
        firstStage: {
            greenCards: 1,
            blueCards: 1,
            brownCards: 2,
        },
        secondStage: {
            greenCards: 2,
            blueCards: 1,
            brownCards: 3,
        },
        thirdStage: {
            greenCards: 2,
            blueCards: 0,
            brownCards: 4,
        },
    },
    {
        id: 'cthulhu',
        name: 'cthulhu',
        firstStage: {
            greenCards: 0,
            blueCards: 2,
            brownCards: 2,
        },
        secondStage: {
            greenCards: 1,
            blueCards: 0,
            brownCards: 3,
        },
        thirdStage: {
            greenCards: 3,
            blueCards: 0,
            brownCards: 4,
        },
    },
    {
        id: 'iogSothoth',
        name: 'iogsothoth',
        firstStage: {
            greenCards: 0,
            blueCards: 1,
            brownCards: 2,
        },
        secondStage: {
            greenCards: 2,
            blueCards: 1,
            brownCards: 3,
        },
        thirdStage: {
            greenCards: 3,
            blueCards: 0,
            brownCards: 4,
        },
    },
    {
        id: 'shubNiggurath',
        name: 'shubniggurath',
        firstStage: {
            greenCards: 1,
            blueCards: 1,
            brownCards: 2,
        },
        secondStage: {
            greenCards: 3,
            blueCards: 1,
            brownCards: 2,
        },
        thirdStage: {
            greenCards: 2,
            blueCards: 0,
            brownCards: 4,
        },
    },
]

class CardsList {
    constructor(cardsGreen, cardsBrown, cardsBlue) {
        this.unsortedDeckOfCard = {
            green:[],
            brown:[],
            blue:[]
        };//object for normal mode
        this.unsortedDeckOfCard.green = cardsGreen;
        this.unsortedDeckOfCard.brown = cardsBrown;
        this.unsortedDeckOfCard.blue = cardsBlue;

        this.sortedDeckOfCard = {
            easy: {
                green: [],
                brown: [],
                blue: []
            },
            normal: {
                green: [],
                brown: [],
                blue: []
            },
            hard: {
                green: [],
                brown: [],
                blue: []
            }
        }; // object for processing to easy or hard mode
        this.#sortCards(cardsGreen);
        this.#sortCards(cardsBrown);
        this.#sortCards(cardsBlue)
    }
    //method for sorting cards
    #sortCards(cards) {
        cards.forEach(card => {
            switch (card.difficulty) {
                case 'easy':
                    this.sortedDeckOfCard.easy[card.color].push(card);
                    break;
                case 'normal':
                    this.sortedDeckOfCard.normal[card.color].push(card);
                    break;
                case 'hard':
                    this.sortedDeckOfCard.hard[card.color].push(card);
                    break;
            }
        })
    }
    getEasyDeck() {
        return {
            green: {
                easy: this.sortedDeckOfCard.easy.green,
                normal: this.sortedDeckOfCard.normal.green
            },
            brown: {
                easy: this.sortedDeckOfCard.easy.brown,
                normal: this.sortedDeckOfCard.normal.brown
            },
            blue: {
                easy: this.sortedDeckOfCard.easy.blue,
                normal: this.sortedDeckOfCard.normal.blue
            }
        }
    }
    getNormalDeck() {
        return {
            green: this.unsortedDeckOfCard.green,
            brown: this.unsortedDeckOfCard.brown,
            blue: this.unsortedDeckOfCard.blue
        }
    }
    getHardDeck() {
        return {
            green: {
                hard: this.sortedDeckOfCard.hard.green,
                normal: this.sortedDeckOfCard.normal.green
            },
            brown: {
                hard: this.sortedDeckOfCard.hard.brown,
                normal: this.sortedDeckOfCard.normal.brown
            },
            blue: {
                hard: this.sortedDeckOfCard.hard.blue,
                normal: this.sortedDeckOfCard.normal.blue
            }
        }
    }
}

class Ancients {
    constructor(ancients) {
        this.ancientsData = ancients;
        this.ancients = document.querySelector('.ancients');
        this.ancientsArr = [];
        this.ancientsArr.push(document.querySelector('.azathoth'));
        this.ancientsArr.push(document.querySelector('.cthulhu'));
        this.ancientsArr.push(document.querySelector('.iogsothoth'));
        this.ancientsArr.push(document.querySelector('.shubniggurath'));
        this.ancients.addEventListener('click', (clkEvent) => this.#setScheme(clkEvent));
        this.ev = new CustomEvent('classEvent');
    }
    #setScheme(e) {
        let countAncients = null;
        switch (e.target.className) {
            case 'azathoth':
                countAncients = 0;
                break;
            case 'cthulhu':
                countAncients = 1;
                break;
            case 'iogsothoth':
                countAncients = 2;
                break;
            case 'shubniggurath':
                countAncients = 3;
                break;
            default:
                countAncients = 4;
                break;
        }
        this.#setStyleAncientsElem(countAncients);
        if (countAncients !== 4) {
            this.save = this.ancientsData[countAncients];
            this.scheme = [];
            this.scheme.push(this.save.firstStage);
            this.scheme.push(this.save.secondStage);
            this.scheme.push(this.save.thirdStage);
            this.save = null;
            let schemeBlock = document.querySelector('.scheme');
            schemeBlock.dispatchEvent(this.ev);
        } else {
            let err = document.querySelector('.error');
            err.textContent = 'Выберите Древнего!';
            this.scheme = undefined;
        }
    }
    #setStyleAncientsElem(countAncients) {
        this.ancientsArr.forEach((elem, index) => {
            if (index === countAncients) {
                elem.className = this.ancientsData[index].name + ' ancients-changed';
            } else {
                elem.className = this.ancientsData[index].name;
            }
        })
    }
}

class Level {
    constructor() {
        this.difficulties = [
            {
                id: 'very-easy'
            },
            {
                id: 'easy'
            },
            {
                id: 'normal'
            },
            {
                id: 'hard'
            },
            {
                id: 'very-hard'
            }
        ]
        this.lvlCount = null;
        this.elemLvl = document.querySelectorAll('.level-item');
        this.lvlList = document.querySelector('.level-list');
        this.lvlList.addEventListener('click', event => this.#setLvl(event));
        this.ev = new CustomEvent('classEvent');
    }
    #setLvl(e) {
        this.difficulties.forEach((el, index) => {
            if (e.target.id === el.id) {
                this.lvlCount = index;
            }
        })
        this.elemLvl.forEach((elem, index) => {
            if (index === this.lvlCount) {
                elem.className = 'level-item' + ' level-changed';
            } else {
                elem.className = 'level-item';
            }
        })
        let schemeBlock = document.querySelector('.scheme');
        schemeBlock.dispatchEvent(this.ev);
    }
}

class Deck extends CardsList {
    constructor(cardsGreen, cardsBrown, cardsBlue, ancients) {
        super(cardsGreen, cardsBrown, cardsBlue);
        this.ancients = new Ancients(ancients);
        this.level = new Level();
        this.stageClickControl = 0;
        let stageArr = [];
        stageArr.push(document.querySelectorAll('.green'));
        stageArr.push(document.querySelectorAll('.brown'));
        stageArr.push(document.querySelectorAll('.blue'));
        //======Scheme Block=========//
        this.cardsArr = {};
        this.deck = {
            0: {
                greenCards: stageArr[0][0],
                brownCards: stageArr[1][0],
                blueCards: stageArr[2][0],
            },
            1: {
                greenCards: stageArr[0][1],
                brownCards: stageArr[1][1],
                blueCards: stageArr[2][1],
            },
            2: {
                greenCards: stageArr[0][2],
                brownCards: stageArr[1][2],
                blueCards: stageArr[2][2]
            }
        };
        //===========================//
        this.card = document.querySelector('.right');
        this.clickDeck = document.querySelector('.left-deck');
        this.err = document.querySelector('.error');
        this.schemeBlock = document.querySelector('.scheme');
        this.schemeBlock.addEventListener('classEvent', () => this.setScheme());
    }
    setScheme() {
        this.cardsArr = {
            0: [],
            1: [],
            2: []
        };
        this.card.src = "./assets/mythicCardBackground.png";
        if (this.ancients.scheme === undefined) {
            this.err.textContent = 'Выберите Древнего!';
            return;
        } else if (this.level.lvlCount === null) {
            this.err.textContent = 'Выберите сложность!';
            return;
        } else {
            this.err.textContent = '';
        }
        //======Mix cards======>
        let cards;
        let decks;
        let addedCards;
        switch (this.level.lvlCount) {
            case 0:
                cards = this.getEasyDeck();
                decks = {
                    green: cards.green.easy,
                    brown: cards.brown.easy,
                    blue: cards.blue.easy
                }
                addedCards = {
                    green: cards.green.normal,
                    brown: cards.brown.normal,
                    blue: cards.blue.normal
                }
                decks = this.#createDeckVeryEasy(decks, addedCards);
                decks = this.#shuffleDeck(decks);
                this.#formatSchemeArray(decks);
                break;
            case 1:
                cards = this.getEasyDeck();
                decks  = {
                    green: cards.green.easy,
                    brown: cards.brown.easy,
                    blue: cards.blue.easy
                }
                decks.green = decks.green.concat(cards.green.normal);
                decks.brown = decks.brown.concat(cards.brown.normal);
                decks.blue = decks.blue.concat(cards.blue.normal);
                decks = this.#createDeckEasyNormalHard(decks);
                decks = this.#shuffleDeck(decks);
                this.#formatSchemeArray(decks);
                break;
            case 2:
                decks = this.getNormalDeck();
                decks = this.#createDeckEasyNormalHard(decks);
                decks = this.#shuffleDeck(decks);
                this.#formatSchemeArray(decks);
                break;
            case 3:
                cards = this.getHardDeck();
                decks  = {
                    green: cards.green.normal,
                    brown: cards.brown.normal,
                    blue: cards.blue.normal
                }
                decks.green = decks.green.concat(cards.green.hard);
                decks.brown = decks.brown.concat(cards.brown.hard);
                decks.blue = decks.blue.concat(cards.blue.hard);
                decks = this.#createDeckEasyNormalHard(decks);
                decks = this.#shuffleDeck(decks);
                this.#formatSchemeArray(decks);
                break;
            case 4:
                console.log(5);
                break;
        }
        this.clickDeck.addEventListener('click', (e) => this.#clkGetCard(e));
    }
    #clkGetCard(e){
        {
            let endDeck = this.cardsArr[2].length;
            if (endDeck === 0) {
                this.err.textContent = 'Сделать новую колоду?';
                this.err.addEventListener('click', (ev) => {
                    ev.stopImmediatePropagation();
                    this.schemeBlock.dispatchEvent(this.ancients.ev);
                    this.err.removeEventListener('click', () => {});
                })
                return this.stageClickControl = 0;
            }
            if(this.cardsArr[0].length){
                this.stageClickControl = 0;
            }else if(this.cardsArr[1].length){
                this.stageClickControl = 1;
            }else if(this.cardsArr[2].length){
                this.stageClickControl = 2;
            }
            let len = this.cardsArr[this.stageClickControl].length;
            let card;
            let index = this.#random(len-1);
            let saveArr = [];
            for (let i = 0; i < len; i++) {
                if (i === index) {
                    card = this.cardsArr[this.stageClickControl][i];
                } else {
                    saveArr.push(this.cardsArr[this.stageClickControl][i])
                }
            }
            this.cardsArr[this.stageClickControl] = saveArr;
            if (card.color === 'green') {
                this.deck[this.stageClickControl].greenCards.textContent = this.deck[this.stageClickControl].greenCards.textContent - 1;
            } else if (card.color === 'brown') {
                this.deck[this.stageClickControl].brownCards.textContent = this.deck[this.stageClickControl].brownCards.textContent - 1;
            } else if (card.color === 'blue') {
                this.deck[this.stageClickControl].blueCards.textContent = this.deck[this.stageClickControl].blueCards.textContent - 1;
            }

            let imgCard = new Image();
            imgCard.src = card.cardFace;
            imgCard.onload = () => {
                this.card.src = imgCard.src;
            }

            e.stopImmediatePropagation();
        }
    }
    #formatSchemeArray(decks) {
        this.ancients.scheme.forEach((stage, index) => {
            for (const key in stage) {
                if (key === 'greenCards' && decks.green.length !== 0) {
                    let count = stage[key];
                    while (count) {
                        this.cardsArr[index].push(decks.green.pop());
                        count--;
                    }
                } else if (key === 'brownCards' && decks.brown.length !== 0) {
                    let count = stage[key];
                    while (count) {
                        this.cardsArr[index].push(decks.brown.pop());
                        count--;
                    }
                } else if (key === 'blueCards' && decks.blue.length !== 0) {
                    let count = stage[key];
                    while (count) {
                        this.cardsArr[index].push(decks.blue.pop());
                        count--;
                    }
                }
            }
        })

        this.ancients.scheme.forEach((stage, index) => {
            let schemeStage = this.deck[index];
            for (const key in stage) {
                schemeStage[key].textContent = stage[key];
            }
        })
    }
    #createDeckVeryEasy(decks, addedCards) {
        let schemeLength = this.#mathScheme(this.ancients.scheme);
        for (const i in decks) {
            if (decks[i].length < schemeLength[i]) {
                let countNeedCard = schemeLength[i] - decks[i].length;
                let count = 0;
                let arrControl = [];
                while (count < countNeedCard) {
                    let index = this.#random(addedCards[i].length);
                    if (!arrControl.includes(index)) {
                        arrControl.push(index);
                        decks[i].push(addedCards[i].at(index));
                        count++;
                    }
                }
            } else if (decks[i].length > schemeLength[i]) {
                let countNeedDeleteCard = decks[i].length - schemeLength[i];
                let count = 0;
                let arrControl = [];
                while (count < countNeedDeleteCard) {
                    let index = this.#random(decks[i].length);
                    if (!arrControl.includes(index)) {
                        arrControl.push(index);
                        decks[i] = decks[i].filter((card, i) => {
                            if (i !== index) {
                                return card;
                            }
                        })
                        count++;
                    }
                }
            }
        }
        return decks;
    }
    #createDeckEasyNormalHard(decks){
        let lengthScheme = this.#mathScheme(this.ancients.scheme);
        for (const key in lengthScheme) {
            let cards = [];
            let count = lengthScheme[key];
            let arrControl = [];
            while (count){
                let index = this.#random(decks[key].length);
                if(!arrControl.includes(index)){
                    arrControl.push(index);
                    cards.push(decks[key].at(index));
                    count--;
                }
            }
            decks[key] = cards;
        }
        return decks;
    }
    #shuffleDeck(decks) {
        for (const color in decks) {
            let copy = [];
            let arrControl = [];
            let len = decks[color].length;
            let count = 0;
            while (count < len) {
                let index = this.#random(len);
                if (!arrControl.includes(index)) {
                    arrControl.push(index);
                    copy.push(decks[color].at(index));
                    count++;
                }
            }
            decks[color] = copy;
        }
        return decks;
    }
    #mathScheme(scheme) {
        let sumBlue = 0;
        let sumGreen = 0;
        let sumBrown = 0;
        for (const key in scheme) {
            for (const i in scheme[key]) {
                if (i == 'greenCards') {
                    sumGreen = sumGreen + scheme[key][i];
                } else if (i == 'blueCards') {
                    sumBlue = sumBlue + scheme[key][i];
                } else {
                    sumBrown = sumBrown + scheme[key][i];
                }
            }
        }
        return {
            green: sumGreen,
            brown: sumBrown,
            blue: sumBlue
        }
    }
    #random(length) {
        return Math.floor(Math.random() * length);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    let deck = new Deck(cardsGreen, cardsBrown, cardsBlue, ancients);
})

// ============================================>